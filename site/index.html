<!DOCTYPE html>
<meta charset="utf-8">
<style>


.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.g-tip {
  position: absolute;
  pointer-events: none;
}

.g-tip-shadow {
  position: absolute;
  box-shadow: 0 4px 8px rgba(0, 0, 0, .2);
  width: 100%;
  height: 100%;
}

.g-tip-content {
  position: absolute;
  padding: 6px;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  font: 12px sans-serif;
}

.g-tip-box {
  position: absolute;
  fill: #fff;
  stroke: #000;
  stroke-opacity: .2;
}

.g-tip-title,
.g-tip-metric-value {
  font-weight: bold;
}

.g-tip-title {
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.g-tip-subtitle {
  margin-bottom: 4px;
}

.g-tip-metric {
  clear: right;
  padding: 2px 0;
}

.g-tip-metric+.g-tip-metric {
  border-top: solid 1px #eee;
}

.g-tip-metric-value {
  float: right;
}

.g-tip-metric-name {
  color: #777;
}
</style>

<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">

<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>


<div class="row">
  <div class="col l8">

    <div class="container" id="description">
      <h3 class="light"> Venmo graph </h3>

      <div class="separator"></div>
    </div>

    <svg width="720" height="800" style="z-index:1"></svg>


    <div class="g-tip" style="width:150px;height:80px;display:none;z-index=2">
      <div class="g-tip-shadow"></div>
      <svg class="g-tip-box" width="150" height="87">
        <path transform="translate(75,91)" d="M0.5,-6.5l5,-5H74.5v-79H-74.5v79H-5Z"/>
      </svg>
      <div class="g-tip-content">
          <div class="g-tip-title">John Doe</div>
          <div class="g-tip-subtitle">jdoe</div>
          <div class="g-tip-metric" data-name="created-at">
              <span class="g-tip-metric-name">User since</span>
              <span class="g-tip-metric-value">Jan '00</span>
          </div>
          <div class="g-tip-metric" data-name="num-transactions">
              <span class="g-tip-metric-name">Transactions</span>
              <span class="g-tip-metric-value">100</span>
          </div>
          <!-- <div class="g-tip-metric" data-name="earnings">
              <span class="g-tip-metric-name">Earnings</span>
              <span class="g-tip-metric-value">$16.2B</span>
          </div> -->
      </div>
    </div>
  </div>


  <div class="col l4" id="transactions">
    <h4 class="light" style="margin-bottom:0px"> Transactions </h4>
    <h4 class="light" style="margin-top:0px"> </h4>

    <table class="striped" style="overflow-y:scroll;height:800px;display:block">
      <col width="100">
      <thead>
        <tr>
          <th> Date </th>
          <th> Caption </th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    </ul>
  </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var svg = d3.select("svg");
    /* .attr("width", window.width)
    .attr("height", window.height); */

var width = +svg.attr("width"),
    height = +svg.attr("height");

var color = d3.scaleOrdinal(d3.schemeCategory20);

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink()
      .id(function(d) { return d.id; }))
    .force("charge", d3.forceManyBody())
    .force("center", d3.forceCenter(width / 2, height / 2));

d3.json("graph.json", function(error, graph) {
  if (error) throw error;

  var link = svg.append("g")
      .attr("class", "links")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line")
      .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

  link
      .on("click", edgeclick)
      .on("mouseover", edgemouseover)
      .on("mouseout", edgemouseout);

  var node = svg.append("g")
      .attr("class", "nodes")
    .selectAll("circle")
    .data(graph.nodes)
    .enter().append("circle")
      .attr("r", function(d) { return d.size; })
      .attr("fill", function(d) { return color(d.group); })
      .attr("id", function(d) { return d.id})
      .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

  node
      .on("mouseover", mouseover)
      .on("mouseout", mouseout)
      .on("click", click);

  simulation
      .nodes(graph.nodes)
      .on("tick", ticked);

  simulation.force("link")
      .links(graph.links)
      .strength(function (d) {return Math.max(0.01 *  (1 + d.value), .1) }); 

  
  /* simulation.force("radial", d3.forceRadial(200, width/2, height/2)
      .strength(function(d) { return (d.group == 2) ? 0.5 : 0})); */

  var tip = d3.select(".g-tip");

  function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }
});

function mouseover(d) {
  d3.select(this).style("stroke", "#000000")
      .style("stroke-opacity", .3);

  var tip = d3.select(".g-tip")
      .style("display", null)
      .style("left", (d.x - 65 ) + "px")
      .style("top", (d.y - d.size + 5) + "px")
      .classed("persisted", false);

  tip.select(".g-tip-title")
      .text(d.name)

  tip.select(".g-tip-subtitle")
      .text("(" + d.username + ")")
      .style("font-weight", null);

  var tipMetric = tip.selectAll(".g-tip-metric")
      .datum(function() {
          return this.getAttribute("data-name");
      });

  tipMetric.select(".g-tip-metric-value").text(function(name) {
    switch (name) {
      case "created-at":
        return d.created_at
      case "num-transactions":
        return d.num_from + d.num_to
    }
  });

}

function click(d) {
  d3.select(this).style("stroke-opacity", 1);
  d3.select(".g-tip").classed("persisted", true);

  // TODO: need to call the json file that reads in the new data
  d3.json(d.id + ".json", function(error, graph) {
    if (error) throw error;

    simulation
      .force("center", null);

    /* d3.forceCenter(width / 2, height / 2) */

    var prevLinkData = d3.local();
    var prevNodeData = d3.local();

    d3.select(".links")
      .selectAll("line")
      .each(function(d) {prevLinkData.set(this, d) });

    d3.select(".nodes")
      .selectAll("circle")
      .each(function (d) {prevNodeData.set(this, d) });

    var link = d3.select(".links")
      .selectAll("line")
      .data(graph.links, function(d) {return d.id} );

    link.each(function(d) {
      var prevData = prevLinkData.get(this);
      d.source.x = prevData.source.x;
      d.source.y = prevData.source.y;
      d.target.x = prevData.target.x;
      d.target.y = prevData.target.x; });

    link.exit().remove();

    link = link
      .enter().append("line")
        .attr("stroke-width", function(d) { return Math.sqrt(d.value); })
        .on("click", edgeclick)
        .on("mouseover", edgemouseover)
        .on("mouseout", edgemouseout)
      .merge(link);


    var node = d3.select(".nodes")
      .selectAll("circle")
      .data(graph.nodes, function(d) { return d.id });

    node.each(function(d) {
      var prevData = prevNodeData.get(this);
      d.x = prevData.x;
      d.y = prevData.y; });

    node
      .exit()
      .transition()
      .delay(function(d,i) { return 10*i })
      .remove();

    node = node
      .enter()
      .append("circle")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended))
      .merge(node)
        .attr("r", function(d) { return d.size; })
        .attr("fill", function(d) { return color(d.group); })
        .attr("id", function(d) { return d.id});

    node
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("click", click);

    simulation
        .nodes(graph.nodes)
        .on("tick", ticked);

    simulation.force("link")
        .links(graph.links)
        .strength(function (d) {return Math.max(0.01 *  (1 + d.value), .1) }); 

    var t1 = d3.timer(function(e) {
        simulation.alphaTarget(1);
        simulation.force("center",
          d3.forceCenter(width / 2, height / 2));
        t1.stop()},
      500);


    var t2 = d3.timer(function(e) {
        simulation.alphaTarget(0);
        t2.stop()}, 
      1000);

    function ticked() {
      link
          .attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
    }
  });



}

function mouseout(d) {
  d3.select(this)
    .style("stroke", "#FFF")
    .style("stroke-opacity", 1);

 
  var tip = d3.select(".g-tip");
  
  if (!tip.classed("persisted"))
    tip.style("display", "none");
}

function edgemouseover(d) {
  d3.select(this).style("stroke-opacity", 1);

  /*var tip = d3.select(".g-tip")
      .style("left", (d3.event.pageX - 65) + "px")
      .style("top", (d3.event.pageY - 80) + "px")
      .classed("persisted", false);

  tip.select(".g-tip-title")
    .text(d.source.name);

  tip.select(".g-tip-subtitle")
    .text("& " + d.target.name)
    .style("font-weight", "bold");

  var tipMetric = tip.selectAll(".g-tip-metric")
      .datum(function() {
          return this.getAttribute("data-name");
      });

  tipMetric.select(".g-tip-metric-value").text(function(name) {
    switch (name) {
      case "created-at":
        return "N/A";
      case "num-transactions":
        return d.value;
    }
  }); */


}

function edgeclick(d) {

  d3.select("#transactions").selectAll("h4")
    .data([d.source, d.target])
    .text(function (d) {return d.name });

  var transactions = d3.select("#transactions")
      .select("tbody")
      .selectAll("tr")
      .data(d.transactions, function (d) { return d.id} );

  var rows = transactions
      .enter()
      .append("tr");

  rows
      .append("td")
      .text(function (d) { return d.created_time });

  rows.append("td")
      .text(function (d) {return d.caption });

  transactions.exit().remove();

}

function edgemouseout(d) {
  d3.select(this).style("stroke-opacity", null);
}

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}


</script>

